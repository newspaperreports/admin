// тЬЕ рж▓рж╛ржЗрж╕рзЗржирзНрж╕ ржУ ржбрзЛржорзЗржЗржи ржпрж╛ржЪрж╛ржЗ рж╕рж╣ ржкржкржЖржк рж╕рзНржХрзНрж░рж┐ржкрзНржЯ

// ЁЯФЧ JSON ржлрж╛ржЗрж▓рзЗрж░ ржЗржЙржЖрж░ржПрж▓ ржпрзЗржЦрж╛ржи ржерзЗржХрзЗ ржкржкржЖржкрзЗрж░ рждржерзНржп ржЖрж╕ржмрзЗ
const jsonUrl = "https://raw.githubusercontent.com/newspaperreports/admin/main/as/auth/notification/wt/verify/user/pt/current/lct/todayLive.wt.json";

// ЁЯФЧ HTML ржлрж╛ржЗрж▓ ржЗржЙржЖрж░ржПрж▓ ржпрзЗржЯрж╛ ржкржкржЖржкрзЗрж░ ржХрж╛ржарж╛ржорзЛ ржзрж╛рж░ржг ржХрж░рзЗ
const htmlUrl = "https://cdn.jsdelivr.net/gh/newspaperreports/admin@main/as/auth/notification/wt/verify/user/pt/current/lct/index.html";

// ЁЯФЧ CSS ржлрж╛ржЗрж▓ ржЗржЙржЖрж░ржПрж▓ ржпрзЗржЯрж╛ ржкржкржЖржкрзЗрж░ ржбрж┐ржЬрж╛ржЗржи ржХржирзНржЯрзНрж░рзЛрж▓ ржХрж░рзЗ
const cssUrl = "https://cdn.jsdelivr.net/gh/newspaperreports/admin@main/as/auth/notification/wt/verify/user/pt/current/lct/todayLive.wt.css";

// тП▒я╕П ржкржкржЖржк ржмржирзНржз ржмрзЛрждрж╛ржо ржжрзЗржЦрж╛ржирзЛрж░ ржмрж┐рж▓ржорзНржм (ржорж┐рж▓рж┐рж╕рзЗржХрзЗржирзНржбрзЗ)
const closeBtnDelay = 3000;

// тП▒я╕П ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржоржпрж╝ ржкрж░рзЗ ржкржкржЖржк ржЕржЯрзЛ ржмржирзНржз рж╣ржмрзЗ
const autoCloseDelay = 20000;

// ЁЯФР base64 ржП ржЖржЗржбрзЗржирзНржЯрж┐ржлрж╛ржпрж╝рж╛рж░ ржПржиржХрзЛржб ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи
function utf8ToBase64(str) {
  return btoa(unescape(encodeURIComponent(str)));
}

// тЬЕ ржкржкржЖржк HTML ржбрж╛ржЙржирж▓рзЛржб ржУ ржЗржиржЬрзЗржХрзНржЯ ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи
async function loadPopupHTML(retry = 0) {
  try {
    const response = await fetch(htmlUrl); // HTML ржлрж╛ржЗрж▓ рж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
    const htmlText = await response.text(); // ржЯрзЗржХрзНрж╕ржЯрзЗ рж░рзВржкрж╛ржирзНрждрж░

    const wrapper = document.createElement("div"); // ржирждрзБржи div ржмрж╛ржирж╛ржирзЛ
    wrapper.innerHTML = htmlText.trim(); // HTML рж╕рзЗржЯ ржХрж░рж╛

    // ржпржжрж┐ ржкрзБрж░рж╛рждржи ржПрж▓рж┐ржорзЗржирзНржЯ ржирж╛ ржерж╛ржХрзЗ рждржмрзЗ ржЗржиржЬрзЗржХрзНржЯ ржХрж░рж┐
    if (!document.getElementById("adminNotification")) {
      while (wrapper.firstChild) {
        document.body.appendChild(wrapper.firstChild); // ржкрзНрж░рждрж┐ржЯрж┐ ржПрж▓рж┐ржорзЗржирзНржЯ body рждрзЗ ржпрзЛржЧ
      }
      console.log("тЬЕ Popup HTML loaded and injected.");
    } else {
      console.log("тД╣я╕П Popup HTML already present.");
    }

    // ржЗржиржЬрзЗржХрж╢ржи рж╕ржлрж▓ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рж╛
    if (!document.getElementById("adminNotification") && retry < 3) {
      setTimeout(() => loadPopupHTML(retry + 1), 500); // ржкрзБржирж░рж╛рзЯ ржЪрзЗрж╖рзНржЯрж╛
    } else if (!document.getElementById("adminNotification")) {
      console.error("тЭМ Popup HTML inject failed! #adminNotification not found after retries.");
    }
  } catch (error) {
    console.error("тЭМ Popup HTML load failed:", error);
  }
}

// тЬЕ CSS ржлрж╛ржЗрж▓ ржпрзБржХрзНржд ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи
function injectPopupCSS() {
  if (!document.querySelector(`link[href="${cssUrl}"]`)) {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = cssUrl;
    document.head.appendChild(link);
  }
}

// тЬЕ рж▓рж╛ржЗрж╕рзЗржирзНрж╕ ржпрж╛ржЪрж╛ржЗ ржлрж╛ржВрж╢ржи
function isLicenseValid(data) {
  const currentDomain = window.location.hostname.replace('www.', '');
  return (
    Array.isArray(data.allowedDomains) &&
    data.allowedDomains.includes(currentDomain) &&
    data.licenseKey === "NewspaperReports-AS - Life Official"
  );
}

// ЁЯЪи рж▓рж╛ржЗрж╕рзЗржирзНрж╕ ржнрж╛ржпрж╝рзЛрж▓рзЗрж╢ржи рж░рж┐ржкрзЛрж░рзНржЯ ржХрж░рж╛рж░ ржлрж╛ржВрж╢ржи
function reportLicenseViolation(data) {
  const adminEmail = data.notification || "asupdatemedia518@gmail.com";
  const subject = encodeURIComponent("ЁЯЪи рж▓рж╛ржЗрж╕рзЗржирзНрж╕ ржЫрж╛ржбрж╝рж╛ PopUp ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЪрзЗрж╖рзНржЯрж╛");
  const body = encodeURIComponent(
    `тЭМ рж▓рж╛ржЗрж╕рзЗржирзНрж╕ ржЪрзЗржХ ржмрзНржпрж░рзНрже!\n\nЁЯМР Domain: ${window.location.hostname}\nЁЯХУ Time: ${new Date().toLocaleString()}\n\nJSON Info:\n${JSON.stringify(data, null, 2)}`
  );
  window.open(`mailto:${adminEmail}?subject=${subject}&body=${body}`, "_blank");
}

// ЁЯЧГя╕П ржмрж░рзНрждржорж╛ржирзЗ ржкрзНрж░ржжрж░рзНрж╢рж┐ржд ржкржкржЖржк ржЖржЗржбрзЗржирзНржЯрж┐ржлрж╛ржпрж╝рж╛рж░ рж╕ржВрж░ржХрзНрж╖ржг
let currentPopupId = null;

// ЁЯЪА DOMContentLoaded ржЗржнрзЗржирзНржЯрзЗ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржЪрж╛рж▓рж╛ржирзЛ
document.addEventListener("DOMContentLoaded", async () => {
  await loadPopupHTML(); // HTML рж▓рзЛржб
  injectPopupCSS(); // CSS рж▓рзЛржб

  // ржкржкржЖржк ржПрж▓рж┐ржорзЗржирзНржЯ ржЖржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзЗ рждржерзНржп рж▓рзЛржб ржХрж░рж╛
  function waitAndLoadNotificationData(attempt = 0) {
    const popup = document.getElementById("adminNotification");
    if (popup) {
      loadNotificationData();
    } else if (attempt < 5) {
      setTimeout(() => waitAndLoadNotificationData(attempt + 1), 1000);
    } else {
      console.error("тЭМ Popup container (adminNotification) DOM-ржП ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐!");
    }
  }
  waitAndLoadNotificationData();

  // тЬЛ ржкржкржЖржк ржХрзНрж▓рзЛржЬ ржмрж╛ржЯржи ржХрзНрж▓рж┐ржХ ржЗржнрзЗржирзНржЯ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░
  document.addEventListener("click", (e) => {
    if (e.target.id === "popupCloseBtn" || e.target.closest("#popupCloseBtn")) {
      localStorage.setItem("popup_closed_by_user", "1");
      localStorage.setItem("popup_last_seen_id", currentPopupId);
      handleCloseOrVisit();
    }
  });

  // ЁЯФБ рзйрзж рж╕рзЗржХрзЗржирзНржб ржкрж░ржкрж░ рждржерзНржп ржЖржкржбрзЗржЯ
  setInterval(loadNotificationData, 30000);
});

// ЁЯУе JSON ржбрзЗржЯрж╛ рж▓рзЛржб ржУ ржкржкржЖржк ржжрзЗржЦрж╛ржирзЛрж░ ржлрж╛ржВрж╢ржи
async function loadNotificationData() {
  try {
    const popup = document.getElementById("adminNotification");
    if (!popup) {
      console.warn("тЪая╕П Popup container ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐ тАУ ржЖржмрж╛рж░ рж▓рзЛржб ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ рж╣ржЪрзНржЫрзЗ");
      await loadPopupHTML();
      return;
    }

    const response = await fetch(jsonUrl, { cache: "no-cache" });
    if (!response.ok) throw new Error("тЭМ JSON рж▓рзЛржб ржмрзНржпрж░рзНрже");
    const data = await response.json();

    if (!isLicenseValid(data)) {
      console.warn("тЭМ рж▓рж╛ржЗрж╕рзЗржирзНрж╕ ржЪрзЗржХ ржмрзНржпрж░рзНрже");
      reportLicenseViolation(data);
      return;
    }

    if (data.status?.toLowerCase() === "off") return;

    const enableConsole = !(data.console?.toLowerCase() === "off");
    const identifier = `${data.title}|${data.image}|${data.buttonText}|${data.link}`;
    const encodedIdentifier = utf8ToBase64(identifier);
    currentPopupId = encodedIdentifier;

    const lastSeen = localStorage.getItem("popup_last_seen_id");
    const popupClosedByUser = localStorage.getItem("popup_closed_by_user");

    if (popup.style.display === "block") {
      if (lastSeen !== encodedIdentifier) {
        handleCloseOrVisit(() => {
          showNotificationFromJSON(data, encodedIdentifier);
        });
      }
      return;
    }

    if (lastSeen === encodedIdentifier && popupClosedByUser === "1") return;

    showNotificationFromJSON(data, encodedIdentifier);
    if (enableConsole) console.log("тЬЕ Popup data loaded:", data);

  } catch (e) {
    console.error("тЭМ Notification loading error:", e);
  }
}

// ЁЯУд JSON ржбрзЗржЯрж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржкржкржЖржк ржнрж┐ржЬрзНржпрзБржпрж╝рж╛рж▓ ржжрзЗржЦрж╛ржирзЛрж░ ржлрж╛ржВрж╢ржи
function showNotificationFromJSON(data, encodedIdentifier) {
  const popup = document.getElementById("adminNotification");
  if (!popup) {
    console.error("тЭМ Popup container DOM-ржП ржирзЗржЗ!");
    return;
  }

  const img = document.getElementById("popupImg");
  const imgSrc = document.getElementById("popupImgSrc");
  const title = document.getElementById("popupTitle");
  const btn = document.getElementById("popupBtn");
  const linkEl = document.getElementById("popupLink");

  if (!img || !imgSrc || !title || !btn || !linkEl) {
    console.error("тЭМ Popup HTML structure mismatch!");
    return;
  }

  img.src = data.image;
  imgSrc.srcset = data.image;
  title.textContent = data.title;
  btn.querySelector("span").textContent = data.buttonText;

  const newLinkEl = linkEl.cloneNode(true);
  linkEl.parentNode.replaceChild(newLinkEl, linkEl);
  newLinkEl.href = data.link;

  newLinkEl.addEventListener("click", (e) => {
    e.preventDefault();
    localStorage.setItem("popup_last_seen_id", encodedIdentifier);
    localStorage.setItem("popup_closed_by_user", "1");
    window.open(data.link, "_blank");
    handleCloseOrVisit();
  });

  popup.style.display = "block";
  popup.classList.remove("fade-out");
  void popup.offsetWidth;
  popup.classList.add("fade-in");

  setTimeout(() => {
    const closeBtn = document.getElementById("popupCloseBtn");
    if (closeBtn) closeBtn.classList.add("show");
  }, closeBtnDelay);

  setTimeout(() => {
    if (popup.style.display === "block") {
      handleCloseOrVisit();
    }
  }, autoCloseDelay);
}

// тЭМ ржкржкржЖржк ржмржирзНржз ржХрж░рж╛рж░ ржЕрзНржпрж╛ржирж┐ржорзЗрж╢ржи ржУ ржХрзНрж▓рж┐ржиржЖржк рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░
function handleCloseOrVisit(callback) {
  const popup = document.getElementById("adminNotification");
  if (!popup) return;

  const closeBtn = document.getElementById("popupCloseBtn");
  if (closeBtn) closeBtn.classList.remove("show");

  popup.classList.remove("fade-in");
  popup.classList.add("fade-out");

  setTimeout(() => {
    popup.style.display = "none";
    if (typeof callback === "function") callback();
  }, 300);
}
