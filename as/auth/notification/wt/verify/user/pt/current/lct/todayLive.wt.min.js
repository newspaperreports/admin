(function () {
  const POPUP_KEY = 'popup_shown_count';
  const POPUP_DATE_KEY = 'popup_last_date';
  const MAX_POPUP_PER_DAY = 3;

  const HTML_URL = 'https://cdn.jsdelivr.net/gh/newspaperreports/admin@main/as/auth/notification/wt/verify/user/pt/current/lct/index.html'; // üîÅ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
  const CSS_URL = 'https://cdn.jsdelivr.net/gh/newspaperreports/admin@main/as/auth/notification/wt/verify/user/pt/current/lct/todayLive.wt.css';  // üîÅ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®

  function getTodayDate() {
    return new Date().toISOString().split('T')[0];
  }

  function shouldShowPopup() {
    const today = getTodayDate();
    const lastDate = localStorage.getItem(POPUP_DATE_KEY);
    let count = parseInt(localStorage.getItem(POPUP_KEY)) || 0;

    if (lastDate !== today) {
      localStorage.setItem(POPUP_DATE_KEY, today);
      localStorage.setItem(POPUP_KEY, '1');
      return true;
    }

    if (count < MAX_POPUP_PER_DAY) {
      localStorage.setItem(POPUP_KEY, (count + 1).toString());
      return true;
    }

    return false;
  }

  function loadPopupHtml(url) {
    return fetch(url)
      .then(res => res.text())
      .then(html => {
        const container = document.createElement('div');
        container.innerHTML = html;
        document.body.appendChild(container);
        return container.querySelector('#asNprWtFloatArea');
      });
  }

  function injectCss(url) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = url;
    document.head.appendChild(link);
  }

  function showPopup(popup) {
    popup.classList.add('asNpr_wt_show');

    const closeBtn = popup.querySelector('.asNpr_wt_hide');
    const okBtn = popup.querySelector('.asNpr_wt_ok_btn');

    const closePopup = () => {
      popup.classList.add('asNpr_wt_fade_out');
      setTimeout(() => popup.remove(), 400);
    };

    if (closeBtn) closeBtn.addEventListener('click', closePopup);
    if (okBtn) okBtn.addEventListener('click', closePopup);
  }

  function checkLocationAndShow() {
    if (!navigator.geolocation) {
      if (shouldShowPopup()) loadPopupHtml(HTML_URL).then(showPopup);
      return;
    }

    navigator.geolocation.getCurrentPosition(
      () => {}, // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶¶‡¶ø‡¶≤‡ßá popup ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨ ‡¶®‡¶æ
      () => {
        if (shouldShowPopup()) loadPopupHtml(HTML_URL).then(showPopup);
      }
    );
  }

  document.addEventListener('DOMContentLoaded', () => {
    injectCss(CSS_URL);
    checkLocationAndShow();
  });
})();
